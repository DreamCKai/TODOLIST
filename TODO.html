<!--/**
 * Copyright (c) [2025] [Bohao.Zhang] [DreamCKai.github]
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 */-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç®€æ˜“å¾…åŠæ¸…å•</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;

        }

		#app {
			position: relative;
		    max-width: 800px;
		    margin: auto;
		    background-color: #f8f8f8;
		    overflow: hidden;
			min-height: 100vh; /* ç¡®ä¿çˆ¶å®¹å™¨å§‹ç»ˆæœ‰é«˜åº¦ */
		}

		/* ä¾§è¾¹æ æ ·å¼ */
		.sidebar {
		    position: absolute;
		    left: 0;
		    top: 0;
		    width: 200px;
		    height: 100%;
		    background-color: #f5f5f5;
		    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
		    transition: transform 0.3s ease-out; /* è‡ªå®šä¹‰ç¼“åŠ¨æ›²çº¿ */
		    z-index: 1000;
		    padding: 20px;
		    box-sizing: border-box;
		}

		.sidebar.collapsed {
		    transform: translateX(-180px);
		}
		/* æ‚¬åœæ—¶çŸ­æš‚å±•å¼€è§¦å‘æ¡ */
		.sidebar.collapsed:hover {
    		transform: translateX(calc(-100% + 30px));
    		transition: transform 0.2s ease-out;
		}
		.sidebar-toggle {
		    position: absolute;
		    right: 10px;
		    top: 10px;
		    cursor: pointer;
		    font-size: 20px;
		    background: none;
		    border: none;
		}
		.sidebar-content {
		    margin-top: 30px;
		}
		.sidebar-content button{
		    margin-top: 10px;
		}
		/* ä¾§è¾¹æ æ ·å¼ */

		/*å¾…åŠäº‹é¡¹åŒºæ ·å¼*/
		.container {
		    position: relative;
		    margin-left: 200px; /* ä¾§è¾¹æ å®½åº¦ */
		    width: calc(100% - 240px); /* 200px + 40px ç•™ç™½ */
		    padding: 20px;
		    transition: all 0.3s ease;
		    background-color: white;
		    /* ä½¿ç”¨ transform æ›¿ä»£ display åˆ‡æ¢ */
		    transform: translateX(0);
		    opacity: 1;
		}
        
        .container.full-width {
            margin-left: 20px;
        }

		/* æŠ˜å çŠ¶æ€ */
		.container.collapsed {
		    transform: translateX(100%);
		    opacity: 0;
		    pointer-events: none; /* ç¦ç”¨äº¤äº’ */
		}

		/* ä¾§è¾¹æ æŠ˜å æ—¶çš„è°ƒæ•´ */
		.sidebar.collapsed ~ .container {
		    margin-left: 20px;     /* æŠ˜å æ—¶å–æ¶ˆå·¦ä¾§é—´è· */
		    width: calc(100% - 40px);        /* å æ»¡çˆ¶å®¹å™¨å®½åº¦ */
		}

        .input-group {
            display: flex;
            margin-bottom: 20px;
        }
		
		/* æ§åˆ¶è¡Œæ ·å¼ */
		.control-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin: 15px 0;
			gap: 15px;
		}
		
		/* ç­›é€‰æŒ‰é’®ç»„ */
		.filter-group {
			display: flex;
			gap: 8px;
		}
		
		.filter-group button {
			padding: 6px 12px;
			background: #e0e0e0;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.2s;
		}
		
		.filter-group button:hover {
			background: #d0d0d0;
		}

		.filter-group button.active {
		    background: #2196F3;  /* è“è‰²èƒŒæ™¯ */
		    color: white;
		    box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);  /* æŠ•å½±æ•ˆæœ */
		}
		
		/* æ’åºæ§åˆ¶åŒºåŸŸ */
		.sort-controls {
			margin: 20px 0;
			padding: 10px;
			background: #f8f8f8;
			border-radius: 4px;
		}
		
		.sort-options {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin-bottom: 8px;
		}
		
		/* æ’åºä¸‹æ‹‰èœå• */
		.sort-controls select {
			padding: 6px 12px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
			background: white;
			cursor: pointer;
		}
		
		.sort-controls select:hover {
			border-color: #bbb;
		}
		
		.sort-options button {
			padding: 6px 12px;
			background: #e0e0e0;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.2s;
		}
		
		.sort-options button:hover {
			background: #d0d0d0;
			transform: translateY(-1px);
		}
		
		/* ç§»é™¤åŸæ¥çš„æ’åºæ ·å¼ */
		.current-sort {
			display: none;
		}
		
		/* ä¼˜å…ˆçº§è§†è§‰æ ·å¼ */
		li.low-priority {
			border-left: 4px solid #4CAF50; /* ç»¿è‰² */
		}
		li.medium-priority {
			border-left: 4px solid #FFC107; /* é»„è‰² */
		}
		li.high-priority {
			border-left: 4px solid #F44336; /* çº¢è‰² */
		}
		
		.priority-select {
			display: none;
			position: absolute;
			background: white;
			border: 1px solid #ddd;
			border-radius: 4px;
			padding: 5px;
			z-index: 10;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}
		
		.priority-badge {
			cursor: pointer;
			user-select: none;
		}
		
		.high-priority .priority-badge {
			background: #ffebee;
			color: #c62828;
		}
		.medium-priority .priority-badge {
			background: #fff8e1;
			color: #ff8f00;
		}
		.low-priority .priority-badge {
			background: #e8f5e9;
			color: #2e7d32;
		}
		
		.priority-options {
			display: flex;
			flex-direction: column;
			gap: 3px;
		}
		
		.priority-option {
			padding: 3px 8px;
			border-radius: 3px;
			cursor: pointer;
		}
		
		.priority-option:hover {
			background: #f0f0f0;
		}
		
		.high-option { color: #c62828; }
		.medium-option { color: #ff8f00; }
		.low-option { color: #2e7d32; }

        #taskInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        .container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .container li {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background-color: #f8f8f8;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .container li:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .completed {
            background-color: #e8e8e8;
            text-decoration: line-through;
            color: #666;
        }

        .delete-btn {
            margin-left: auto;
            background-color: #ff4444;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .delete-btn:hover {
            background-color: #cc0000;
        }
		
		.complete-btn, .delete-btn {
			background: none;
			border: none;
			cursor: pointer;
			font-size: 16px;
			padding: 0 5px;
		}

		.complete-btn:hover, .delete-btn:hover {
			opacity: 0.7;
		}


        .clear-all {
            background-color: #ff4444;
            margin-top: 20px;
            width: 100%;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(0.98);
            background: #e0e0e0 !important;
        }

        .drag-over {
            border-top: 2px solid #4CAF50;
        }
		
		/* ç¼–è¾‘ç›¸å…³æ ·å¼ */
		.edit-form {
			transition: all 0.3s ease;
			max-height: 0;
			overflow: hidden;
		}
		
		.edit-form[style*="display: block"] {
			max-height: 200px;
		}
		
		.edit-form input {
			padding: 8px;
			width: 60%;
			margin-right: 5px;
		}
		
		.edit-form select {
			padding: 8px;
			margin-right: 5px;
		}
		
		.edit-form button {
			padding: 8px 12px;
		}
		
		.task-content {
			display: flex;
			align-items: center;
			width: 100%;
			position: relative;
		}
		
		.task-text {
			cursor: pointer;
		}
		
		.task-text:hover {
			text-decoration: underline;
		}
		
		.task-view, .task-edit {
			display: inline-block;
		}
		
		.task-edit-input {
			border: none;
			background: transparent;
			font: inherit;
			padding: 0;
			margin: 0;
			width: auto;
			outline: none;
			border-bottom: 1px dashed #999;
		}
		
		.task-view, .task-edit-input {
			flex-grow: 1;
			text-align: left;
			padding-left: 10px;
			min-width: 0; /* é˜²æ­¢æ–‡æœ¬æº¢å‡º */
		}
		
		.edit-buttons {
			display: flex;
			gap: 5px;
		}

		/*å¾…åŠäº‹é¡¹åŒºæ ·å¼*/
    </style>
</head>
<body>
	<div id="app">
		<!-- ä¾§è¾¹æ  -->
		<div class="sidebar" id="sidebar" onclick="toggleSidebar(event)">
			<!--<button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>-->
			<div class="sidebar-content">
				<h3>æ§åˆ¶é¢æ¿</h3>
				<button onclick="toggleTodoArea(event)">åˆ‡æ¢å¾…åŠäº‹é¡¹</button>
				<button onclick="toggleCompletedArea(event)">åˆ‡æ¢å·²å®Œæˆäº‹é¡¹</button>
				<!-- å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–æ§åˆ¶é€‰é¡¹ -->
			</div>
		</div>
		<!-- å¾…åŠäº‹é¡¹åŒº -->
		<div class="container" id="mainContainer" onclick="toggleSidebar(event)">
			<h1>å¾…åŠäº‹é¡¹ ğŸ“</h1>
			<div class="controls">
				<div class="input-group">
					<input type="text" id="taskInput" placeholder="è¾“å…¥æ–°ä»»åŠ¡...">
					<select id="prioritySelect">
						<option value="low" selected>ä½ä¼˜å…ˆçº§</option>
						<option value="medium">ä¸­ä¼˜å…ˆçº§</option>
						<option value="high">é«˜ä¼˜å…ˆçº§</option>
					</select>
					<button onclick="addTask()">æ·»åŠ ä»»åŠ¡</button>
				</div>

				<!-- åˆå¹¶åçš„ç­›é€‰å’Œæ’åºæ§åˆ¶è¡Œ -->
				<div class="control-row">
					<div class="filter-group">
						<button data-priority="all" onclick="filterTasks('all')">å…¨éƒ¨</button>
						<button data-priority="high" onclick="filterTasks('high')">é«˜</button>
						<button data-priority="medium" onclick="filterTasks('medium')">ä¸­</button>
						<button data-priority="low" onclick="filterTasks('low')">ä½</button>
					</div>

					<div class="sort-controls">
						<select id="sortSelect" onchange="sortTasks(this.value)">
							<option value="added" selected>æ·»åŠ æ—¶é—´ â–¼</option>
							<option value="added-desc">æ·»åŠ æ—¶é—´ â–²</option>
							<option value="priority">ä¼˜å…ˆçº§ â–¼</option>
							<option value="priority-asc">ä¼˜å…ˆçº§ â–²</option>
						</select>
					</div>
				</div>
			</div>
			<ul id="taskList"></ul>
			<button class="clear-all" onclick="clearAllTasks()">æ¸…é™¤æ‰€æœ‰ä»»åŠ¡</button>
		</div>
		<!-- å·²å®Œæˆäº‹é¡¹åŒº -->
		<div id="completedContainer" class="container" onclick="toggleSidebar(event)">
		    <h2>å·²å®Œæˆäº‹é¡¹</h2>
			<ul id="completedTaskList"></ul>
			<button class="clear-all" onclick="clearAllCompletedTasks()">æ¸…é™¤æ‰€æœ‰ä»»åŠ¡</button>
		</div>
	</div>

    <script>
		// æ‹–æ‹½ç›¸å…³å˜é‡
        let dragSrcEl = null;
        let currentDragIndex = -1;
		
		// ä¿®æ”¹åˆå§‹åŒ–ä»£ç ï¼Œè®¾ç½®é»˜è®¤æ’åºé€‰é¡¹
		document.addEventListener('DOMContentLoaded', () => {
			loadTasks();
			loadcompletedTasks();
			initDragAndDrop();
			filterTasks('all');
			
			// è®¾ç½®é»˜è®¤çŠ¶æ€
            document.getElementById('mainContainer').style.display = 'block';

			// è®¾ç½®ä¸Šæ¬¡çš„æ’åºæ–¹å¼æˆ–é»˜è®¤æ’åº
			const savedSort = localStorage.getItem('taskSortPreference') || 'added';
			document.getElementById('sortSelect').value = savedSort;
			sortTasks(savedSort);
			
			// ç¡®ä¿ä¼˜å…ˆçº§é€‰æ‹©å™¨å­˜åœ¨ï¼ˆå¦‚æœHTMLä¸­è¿˜æ²¡æœ‰ï¼‰
			if (!document.getElementById('prioritySelect')) {
				const inputGroup = document.querySelector('.input-group');
				if (inputGroup) {
					const prioritySelect = document.createElement('select');
					prioritySelect.id = 'prioritySelect';
					prioritySelect.innerHTML = `
						<option value="low">ä½ä¼˜å…ˆçº§</option>
						<option value="medium" selected>ä¸­ä¼˜å…ˆçº§</option>
						<option value="high">é«˜ä¼˜å…ˆçº§</option>
					`;
					const addButton = inputGroup.querySelector('button');
					if (addButton) {
						inputGroup.insertBefore(prioritySelect, addButton);
					}
				}
			}
		});

        // åˆå§‹åŒ–æ‹–æ‹½äº‹ä»¶
        function initDragAndDrop() {
            const list = document.getElementById('taskList');
            
            list.addEventListener('dragstart', function(e) {
                dragSrcEl = e.target.closest('li');
                dragSrcEl.classList.add('dragging');
                currentDragIndex = Array.from(list.children).indexOf(dragSrcEl);
            });

            list.addEventListener('dragover', function(e) {
                e.preventDefault();
                const target = e.target.closest('li:not(.dragging)');
                if (!target) return;

                const rect = target.getBoundingClientRect();
                const nextIndex = (e.clientY < rect.top + rect.height / 2) ?
                    Array.from(list.children).indexOf(target) :
                    Array.from(list.children).indexOf(target) + 1;

                list.querySelectorAll('li').forEach(li => li.classList.remove('drag-over'));
                target.classList.add('drag-over');
            });

            list.addEventListener('dragend', function(e) {
                list.querySelectorAll('li').forEach(li => {
                    li.classList.remove('dragging', 'drag-over');
                });
                updateTaskOrder();
            });

            list.addEventListener('drop', function(e) {
                e.preventDefault();
                const target = e.target.closest('li');
                if (!target || !dragSrcEl) return;

                const newIndex = Array.from(list.children).indexOf(target);
                if (currentDragIndex !== newIndex) {
                    const tasks = getTasks();
                    const [movedTask] = tasks.splice(currentDragIndex, 1);
                    tasks.splice(newIndex, 0, movedTask);
                    saveTasks(tasks);
                    rebuildList(tasks);
                }
            });
        }
		
        // æ›´æ–°ä»»åŠ¡é¡ºåºæ˜¾ç¤º
		function rebuildList(tasks) {
			const list = document.getElementById('taskList');
			list.innerHTML = '';
			tasks.forEach(task => addTaskToList(task));
		}

        // æ·»åŠ ä»»åŠ¡ï¼ˆæ”¯æŒå›è½¦é”®ï¼‰
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addTask();
        });

		// ä¾§è¾¹æ æ§åˆ¶å‡½æ•°
		function toggleSidebar(event) {
			const sidebar = document.getElementById('sidebar');
			let isSidebar = event.target.classList.contains('sidebar');
			if(!isSidebar){
				let isSidebarCollapsed = sidebar.classList.contains('collapsed');
				if(isSidebarCollapsed)return;
			}
		    sidebar.classList.toggle('collapsed');
		    //body.classList.toggle('sidebar-expanded');
		}
        
        function toggleTodoArea(event) {
			event.stopPropagation();
			const container = document.getElementById('mainContainer');
			container.style.display = container.style.display === 'none' ? 'block' : 'none';
			//const container = document.getElementById('mainContainer');
    		//container.classList.toggle('collapsed');
				
    		// å¯é€‰ï¼šæŠ˜å æ—¶ç¼©å°ä¾§è¾¹æ ç•™ç™½
    		//const sidebar = document.querySelector('.sidebar');
    		//sidebar.style.width = container.classList.contains('collapsed') ? '0' : '200px';
        }

		// æ–°å¢åˆ‡æ¢å‡½æ•°
		function toggleCompletedArea(event) {
		    event.stopPropagation();
		    const container = document.getElementById('completedContainer');
		    container.style.display = container.style.display === 'none' ? 'block' : 'none';
		    
			//const container = document.getElementById('completedContainer');
    		//container.classList.toggle('collapsed');
		}

		// ä¼˜å…ˆçº§å¸¸é‡å®šä¹‰
		const PRIORITY_WEIGHT = {
			'high': 3,
			'medium': 2,
			'low': 1
		};
		
		// addTaskå‡½æ•°
		function addTask() {
			const input = document.getElementById('taskInput');
			const priority = document.getElementById('prioritySelect').value;
			const taskText = input.value.trim();
			
			if (!taskText) return;
			
			const task = {
				text: taskText,
				completed: false,
				id: Date.now(),
				priority: priority
			};
			
			const tasks = getTasks();
			tasks.push(task);
			saveTasks(tasks);
			addTaskToList(task);
			input.value = '';
			
			// æ·»åŠ åä¿æŒå½“å‰æ’åº
			const currentSort = localStorage.getItem('taskSortPreference') || 'added';
			sortTasks(currentSort);
		}
		
		// addTaskToListå‡½æ•°
		function addTaskToList(task) {
			const li = document.createElement('li');
			li.dataset.id = task.id;
			li.draggable = true;
			li.className = `${task.priority}-priority ${task.completed ? 'completed' : ''}`;
			
			li.innerHTML = `
				<div class="task-content">
					<span class="priority-badge" onclick="showPrioritySelect(${task.id})">
						${getPriorityLabel(task.priority)}
					</span>
					
					<div class="priority-select" id="priority-select-${task.id}">
						<div class="priority-options">
							<div class="priority-option high-option" onclick="changePriority(${task.id}, 'high')">é«˜</div>
							<div class="priority-option medium-option" onclick="changePriority(${task.id}, 'medium')">ä¸­</div>
							<div class="priority-option low-option" onclick="changePriority(${task.id}, 'low')">ä½</div>
						</div>
					</div>
					
					<span class="task-view">${task.text}</span>
					<input class="task-edit-input" value="${task.text}" style="display:none">
					
					<div class="edit-buttons">
						<button class="complete-btn" onclick="toggleComplete(${task.id})">âœ“</button>
						<button class="delete-btn" onclick="deleteTask(${task.id})">Ã—</button>
					</div>
				</div>
			`;
			
			document.getElementById('taskList').appendChild(li);
			setupTextEdit(li, task.id);
		}
		
		// è®¾ç½®æ–‡æœ¬ç¼–è¾‘åŠŸèƒ½
		function setupTextEdit(li, taskId) {
			const taskView = li.querySelector('.task-view');
			const taskEdit = li.querySelector('.task-edit-input');
			let originalText = taskView.textContent;
			
			// ç‚¹å‡»ä»»åŠ¡æ–‡æœ¬å¼€å§‹ç¼–è¾‘
			taskView.addEventListener('click', function() {
				taskView.style.display = 'none';
				taskEdit.style.display = 'inline-block';
				taskEdit.value = originalText;
				taskEdit.focus();
				taskEdit.select();
			});
			
			// å¤±ç„¦æ—¶å¤„ç†
			taskEdit.addEventListener('blur', function() {
				const newText = taskEdit.value.trim();
				
				if (newText && newText !== originalText) {
					// ä¿å­˜æ›´æ”¹
					const tasks = getTasks();
					const task = tasks.find(t => t.id === taskId);
					if (task) {
						task.text = newText;
						saveTasks(tasks);
						taskView.textContent = newText;
						originalText = newText;
					}
				}
				
				taskEdit.style.display = 'none';
				taskView.style.display = 'inline-block';
			});
			
			// æ”¯æŒå›è½¦ä¿å­˜
			taskEdit.addEventListener('keydown', function(e) {
				if (e.key === 'Enter') {
					taskEdit.blur();
				}
			});
		}
		
		// æ˜¾ç¤ºä¼˜å…ˆçº§é€‰æ‹©èœå•
		function showPrioritySelect(taskId) {
			// éšè—æ‰€æœ‰å…¶ä»–ä¼˜å…ˆçº§é€‰æ‹©èœå•
			document.querySelectorAll('.priority-select').forEach(select => {
				select.style.display = 'none';
			});
			
			const select = document.getElementById(`priority-select-${taskId}`);
			select.style.display = 'block';
			
			// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
			const closeHandler = function(e) {
				if (!select.contains(e.target) && e.target.className !== 'priority-badge') {
					select.style.display = 'none';
					document.removeEventListener('click', closeHandler);
				}
			};
			
			setTimeout(() => {
				document.addEventListener('click', closeHandler);
			}, 0);
		}
		
		// æ›´æ”¹ä¼˜å…ˆçº§
		function changePriority(taskId, newPriority) {
			const tasks = getTasks();
			const task = tasks.find(t => t.id === taskId);
			
			if (task && task.priority !== newPriority) {
				task.priority = newPriority;
				saveTasks(tasks);
				
				// æ›´æ–°UI
				const li = document.querySelector(`li[data-id="${taskId}"]`);
				li.className = `${newPriority}-priority ${task.completed ? 'completed' : ''}`;
				li.querySelector('.priority-badge').textContent = getPriorityLabel(newPriority);
				
				// é‡æ–°æ’åº
				const currentSort = localStorage.getItem('taskSortPreference') || 'added';
				sortTasks(currentSort);
			}
			
			// éšè—é€‰æ‹©èœå•
			document.getElementById(`priority-select-${taskId}`).style.display = 'none';
		}
		
		// å¼€å§‹ç¼–è¾‘ä»»åŠ¡
		function startEditTask(id) {
			// éšè—æ‰€æœ‰å…¶ä»–ç¼–è¾‘è¡¨å•
			document.querySelectorAll('.edit-form').forEach(form => {
				form.style.display = 'none';
			});
			
			// æ˜¾ç¤ºå½“å‰ç¼–è¾‘è¡¨å•
			const editForm = document.getElementById(`edit-form-${id}`);
			editForm.style.display = 'block';
			
			// èšç„¦åˆ°è¾“å…¥æ¡†
			const input = document.getElementById(`edit-input-${id}`);
			input.focus();
			input.select();
		}
		
		// ä¿å­˜ç¼–è¾‘
		function saveEdit(id) {
			const newText = document.getElementById(`edit-input-${id}`).value.trim();
			const newPriority = document.getElementById(`edit-priority-${id}`).value;
			
			if (!newText) {
				alert('ä»»åŠ¡å†…å®¹ä¸èƒ½ä¸ºç©º');
				return;
			}
			
			const tasks = getTasks();
			const taskIndex = tasks.findIndex(t => t.id === id);
			
			if (taskIndex !== -1) {
				tasks[taskIndex].text = newText;
				tasks[taskIndex].priority = newPriority;
				saveTasks(tasks);
				
				// é‡æ–°æ„å»ºåˆ—è¡¨ä»¥åº”ç”¨æ›´æ”¹
				rebuildList(tasks);
				
				// æ¢å¤ä¹‹å‰çš„æ’åº
				const currentSort = localStorage.getItem('taskSortPreference') || 'added';
				sortTasks(currentSort);
			}
		}
		
		// å–æ¶ˆç¼–è¾‘
		function cancelEdit(id) {
			document.getElementById(`edit-form-${id}`).style.display = 'none';
		}
		
		// åœ¨edit-inputå…ƒç´ ä¸Šæ·»åŠ keydownäº‹ä»¶ç›‘å¬
		document.getElementById(`edit-input-${id}`).addEventListener('keydown', function(e) {
			if (e.key === 'Enter') saveEdit(id);
			if (e.key === 'Escape') cancelEdit(id);
		});
		
		// æ–°å¢è¾…åŠ©å‡½æ•°
		function getPriorityLabel(priority) {
			const labels = {
				'low': 'ä½',
				'medium': 'ä¸­',
				'high': 'é«˜'
			};
			return labels[priority] || '';
		}
		
		// å®Œæ•´çš„æ’åºåŠŸèƒ½å®ç°
		function sortTasks(sortBy) {
			const tasks = getTasks();
			
			switch(sortBy) {
				case 'priority': // é«˜>ä¸­>ä½
					tasks.sort((a, b) => PRIORITY_WEIGHT[b.priority] - PRIORITY_WEIGHT[a.priority]);
					break;
				case 'priority-asc': // ä½>ä¸­>é«˜
					tasks.sort((a, b) => PRIORITY_WEIGHT[a.priority] - PRIORITY_WEIGHT[b.priority]);
					break;
				case 'added': // æ—§>æ–°
					tasks.sort((a, b) => a.id - b.id);
					break;
				case 'added-desc': // æ–°>æ—§
					tasks.sort((a, b) => b.id - a.id);
					break;
			}
			
			saveTasks(tasks);
			rebuildList(tasks);
			
			// æ›´æ–°UIçŠ¶æ€
			const sortText = {
				'priority': 'ä¼˜å…ˆçº§ â–¼',
				'priority-asc': 'ä¼˜å…ˆçº§ â–²',
				'added': 'æ·»åŠ æ—¶é—´ â–¼',
				'added-desc': 'æ·»åŠ æ—¶é—´ â–²'
			};
			document.querySelector('.current-sort').textContent = `å½“å‰æ’åº: ${sortText[sortBy]}`;
			
			// ä¿å­˜æ’åºåå¥½
			localStorage.setItem('taskSortPreference', sortBy);
			
			// æ›´æ–°ä¸‹æ‹‰èœå•é€‰ä¸­çŠ¶æ€
			document.getElementById('sortSelect').value = sortBy;
			localStorage.setItem('taskSortPreference', sortBy);
		}
		
		function filterTasks(priority) {
		    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
		    const buttons = document.querySelectorAll('.filter-group button');
		    buttons.forEach(btn => btn.classList.remove('active'));
		
		    // æ·»åŠ å½“å‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
		    const activeBtn = document.querySelector(`button[data-priority="${priority}"]`);
		    if (activeBtn) activeBtn.classList.add('active');
		
		    // åŸæœ‰ç­›é€‰é€»è¾‘
		    const tasks = getTasks();
		    const list = document.getElementById('taskList');
		    list.innerHTML = '';
		    if (priority === 'all') {
		        tasks.forEach(addTaskToList);
		    } else {
		        tasks.filter(t => t.priority === priority)
		            .forEach(addTaskToList);
		    }
		}

        function updateTaskOrder() {
            const list = document.getElementById('taskList');
            const newOrder = Array.from(list.children).map(li => parseInt(li.dataset.id));
            const tasks = getTasks();
            
            // æ ¹æ®DOMé¡ºåºé‡æ–°æ’åºæ•°ç»„
            const sortedTasks = newOrder.map(id => 
                tasks.find(task => task.id === id)
            ).filter(Boolean);
            
            saveTasks(sortedTasks);
        }

        function toggleComplete(id) {
            const tasks = getTasks();
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            task.completed = !task.completed;
            saveTasks(tasks);
            
            const listItem = document.querySelector(`li[data-id="${id}"]`);
            listItem.classList.toggle('completed');
        }

        function deleteTask(id) {
			const completedTask = getTasks().find(t => t.id === id);
			addcompletedTask(completedTask);
            const tasks = getTasks().filter(t => t.id !== id);
            saveTasks(tasks);
            document.querySelector(`li[data-id="${id}"]`).remove();
        }

        function clearAllTasks() {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ä»»åŠ¡å—ï¼Ÿ')) {
                localStorage.removeItem('tasks');
                document.getElementById('taskList').innerHTML = '';
            }
        }

        // æœ¬åœ°å­˜å‚¨ç›¸å…³å‡½æ•°
        function saveTasks(tasks = getTasks()) {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

		function getTasks() {
			const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
			// ç¡®ä¿æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¼˜å…ˆçº§
			return tasks.map(task => {
				if (!task.priority) {
					task.priority = 'low';
				}
				return task;
			});
		}

        function loadTasks() {
            const tasks = getTasks();
            tasks.forEach(addTaskToList);
        }

		//å·²å®Œæˆäº‹é¡¹ç›¸å…³å‡½æ•°
		function savecompletedTasks(completedTasks = getcompletedTasks()) {
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
        }

		function getcompletedTasks() {
			const completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '[]');
			// ç¡®ä¿æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¼˜å…ˆçº§
			return completedTasks.map(completedTask => {
				if (!completedTask.completed) {
					completedTask.completed = true;
				}
				return completedTask;
			});
		}

        function loadcompletedTasks() {
            const completedTasks = getcompletedTasks();
            completedTasks.forEach(addcompletedTaskToList);
        }

		// addcompletedTask
		function addcompletedTask(completedTask) {
			completedTask.completed = true;
			const completedTasks = getcompletedTasks();
			completedTasks.push(completedTask);
			savecompletedTasks(completedTasks);
			addcompletedTaskToList(completedTask);
			
		}

		// addcompletedTaskToListå‡½æ•°
		function addcompletedTaskToList(completedTask) {
			const li = document.createElement('li');
			li.dataset.id = completedTask.id;
			li.draggable = true;
			li.className = `${completedTask.priority}-priority }`;
			
			li.innerHTML = `
				<div class="task-content">
					<span class="priority-badge" onclick="showPrioritySelect(${completedTask.id})">
						${getPriorityLabel(completedTask.priority)}
					</span>
					
					<div class="priority-select" id="priority-select-${completedTask.id}">
						<div class="priority-options">
							<div class="priority-option high-option" onclick="changePriority(${completedTask.id}, 'high')">é«˜</div>
							<div class="priority-option medium-option" onclick="changePriority(${completedTask.id}, 'medium')">ä¸­</div>
							<div class="priority-option low-option" onclick="changePriority(${completedTask.id}, 'low')">ä½</div>
						</div>
					</div>
					
					<span class="task-view">${completedTask.text}</span>
					<input class="task-edit-input" value="${completedTask.text}" style="display:none">
					
					<div class="edit-buttons">
						<button onclick="undoCompletedTask(${completedTask.id})">å¤åŸ</button>
						<button onclick="deleteCompletedTask(${completedTask.id})">åˆ é™¤</button>
					</div>
				</div>
			`;
			
			document.getElementById('completedTaskList').appendChild(li);
			setupTextEdit(li, completedTask.id);
		}

		function clearAllCompletedTasks() {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å·²å®Œæˆäº‹é¡¹å—ï¼Ÿ')) {
                localStorage.removeItem('completedTasks');
                document.getElementById('completedTaskList').innerHTML = '';
            }
        }

		function deleteCompletedTask(id){
			let r=confirm("ç¡®è®¤åˆ é™¤å—ï¼Ÿ");
			if (r==true)
			{
			    const completedTasks = getcompletedTasks().filter(t => t.id !== id);
				savecompletedTasks(completedTasks);
				document.querySelector(`li[data-id="${id}"]`).remove();
			}

		}

		function undoCompletedTask(id){
			const task = getcompletedTasks().find(t => t.id === id);
			deleteCompletedTask(id);
			const tasks = getTasks();
			tasks.push(task);
			saveTasks(tasks);
			addTaskToList(task);
		}
    </script>
	
</body>
</html>